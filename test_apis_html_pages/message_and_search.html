<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الدردشة (JWT)</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 15px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        /* --- استايلات الأقسام --- */
        #jwt-section, #chat-section {
            margin-bottom: 20px;
        }
        #chat-messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #e9e9e9;
        }
        /* --- استايلات الرسائل --- */
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            max-width: 80%;
            word-wrap: break-word; /* لضمان عدم تجاوز النص للعرض */
        }
        .message.sent {
            background-color: #dcf8c6;
            margin-left: auto;
            text-align: left;
            margin-right: 0;
        }
        .message.received {
            background-color: #fff;
            margin-right: auto;
            text-align: right;
            margin-left: 0;
        }
        .message small {
            display: block;
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
        }
        /* --- استايلات الحقول والأزرار --- */
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="password"], input[type="number"], textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        textarea#jwt-input { /* استايل خاص لحقل JWT */
             height: 80px;
             resize: vertical;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #send-form {
            display: flex;
        }
        #message-input {
            flex-grow: 1;
            margin-left: 10px; /* مسافة لليمين في RTL */
            margin-right: 0;
        }
        hr {
            margin: 20px 0;
        }
         .error {
            color: red;
            font-size: 0.9em;
            margin-top: -5px;
            margin-bottom: 10px;
         }
         #loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #555;
         }
    </style>
</head>
<body>

<div class="container">
    <h1>تطبيق الدردشة</h1>

    <!-- قسم إدخال JWT (يظهر في البداية) -->
    <div id="jwt-section">
        <h2>إدخال رمز JWT</h2>
        <form id="jwt-form">
            <label for="jwt-input">رمز JWT:</label>
            <textarea id="jwt-input" rows="4" required placeholder="الصق رمز JWT هنا..."></textarea>
            <button type="submit">استخدام الرمز</button>
            <div id="jwt-error" class="error"></div>
        </form>
    </div>

    <!-- قسم الدردشة (يظهر بعد إدخال JWT) -->
    <div id="chat-section" style="display: none;">
        <h2>محادثة</h2>
        <p>معرف المستخدم الحالي: <strong id="current-user-id-display"></strong></p>

        <div>
            <label for="other-user-id">معرف المستخدم الآخر للدردشة معه:</label>
            <input type="number" id="other-user-id" placeholder="أدخل ID المستخدم">
            <button id="load-chat-btn">تحميل المحادثة</button>
             <div id="load-chat-error" class="error"></div>
        </div>

        <hr>

        <div id="current-chat-info"></div>
        <div id="chat-messages">
             <!-- الرسائل ستعرض هنا -->
        </div>
         <div id="loading">جاري التحميل...</div>

        <form id="send-form">
            <input type="text" id="message-input" placeholder="اكتب رسالتك..." required>
            <button type="submit">إرسال</button>
        </form>
         <div id="send-error" class="error"></div>

         <hr>
         <button id="logout-btn">تسجيل الخروج (تغيير الرمز)</button>
    </div>

</div>

<script>
    // --- Variables Globales ---
    let jwtToken = localStorage.getItem('chat_jwt');
    let currentUserId = null;
    let currentChatPartnerId = null;
    let pollingInterval = null;

    // --- DOM Elements ---
    const jwtSection = document.getElementById('jwt-section');
    const jwtForm = document.getElementById('jwt-form');
    const jwtInput = document.getElementById('jwt-input');
    const jwtError = document.getElementById('jwt-error');

    const chatSection = document.getElementById('chat-section');
    const currentUserIdDisplay = document.getElementById('current-user-id-display');
    const otherUserIdInput = document.getElementById('other-user-id');
    const loadChatBtn = document.getElementById('load-chat-btn');
    const loadChatError = document.getElementById('load-chat-error');
    const currentChatInfo = document.getElementById('current-chat-info');
    const chatMessagesDiv = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendForm = document.getElementById('send-form');
    const sendError = document.getElementById('send-error');
    const logoutBtn = document.getElementById('logout-btn');
    const loadingDiv = document.getElementById('loading');


    // --- Fonctions Utilitaires ---

    // دالة بسيطة لتحليل JWT (فقط للحصول على ID المستخدم إذا كان في الـ payload)
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            const parsed = JSON.parse(jsonPayload);
            // تأكد من وجود حقل 'sub' الذي يمثل المعرف
            return parsed && parsed.sub ? parsed : null;
        } catch (e) {
            console.error("Error parsing JWT:", e);
            return null;
        }
    }

    // عرض الرسائل في الواجهة
    function displayMessage(msg) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        if (msg.sender_id === currentUserId) {
            msgDiv.classList.add('sent');
        } else {
            msgDiv.classList.add('received');
        }

        const contentP = document.createElement('p');
        contentP.textContent = msg.content;
        msgDiv.appendChild(contentP);

        const timeSmall = document.createElement('small');
        timeSmall.textContent = new Date(msg.created_at).toLocaleString();
        msgDiv.appendChild(timeSmall);

        chatMessagesDiv.appendChild(msgDiv);
    }

    // تمرير شريط التمرير للأسفل
    function scrollToBottom() {
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }

    // إظهار/إخفاء حالة التحميل
    function showLoading(isLoading) {
        loadingDiv.style.display = isLoading ? 'block' : 'none';
    }

     // مسح حالة الدردشة الحالية
    function clearChatState() {
        stopPolling();
        otherUserIdInput.value = '';
        chatMessagesDiv.innerHTML = '';
        messageInput.value = '';
        currentChatInfo.textContent = '';
        loadChatError.textContent = '';
        sendError.textContent = '';
        currentChatPartnerId = null;
        showLoading(false);
     }

    // إعداد الواجهة بناءً على وجود وصحة الـ JWT
    function setupUIBasedOnToken(token) {
        if (!token) {
             clearChatState();
             jwtSection.style.display = 'block';
             chatSection.style.display = 'none';
             jwtInput.value = ''; // مسح الحقل إذا كان الرمز غير صالح
             return false; // فشل الإعداد
        }

        const payload = parseJwt(token);
        if (payload && payload.sub) {
            currentUserId = payload.sub;
            jwtToken = token; // تحديث المتغير العام بالرمز الصحيح
            currentUserIdDisplay.textContent = currentUserId; // عرض ID المستخدم

            jwtError.textContent = '';
            jwtSection.style.display = 'none';
            chatSection.style.display = 'block';
            // لا نمسح حالة الدردشة هنا للسماح بالاستمرارية إذا كان نفس المستخدم
            console.log("Token مقبول، معرف المستخدم:", currentUserId);
             return true; // نجح الإعداد
        } else {
            // Token موجود لكن غير صالح أو لا يحتوي على 'sub'
            localStorage.removeItem('chat_jwt');
            jwtToken = null;
            currentUserId = null;
            clearChatState();
            jwtSection.style.display = 'block';
            chatSection.style.display = 'none';
            jwtError.textContent = 'رمز JWT غير صالح أو مفقود المعرف (sub).';
             return false; // فشل الإعداد
        }
    }


    // --- Logique Principale ---

    // محاولة إعداد الواجهة بالرمز المخزن عند تحميل الصفحة
    setupUIBasedOnToken(jwtToken);

    // معالج حدث تقديم نموذج JWT
    jwtForm.addEventListener('submit', (e) => {
        e.preventDefault();
        jwtError.textContent = ''; // مسح الأخطاء السابقة
        const enteredToken = jwtInput.value.trim();

        if (!enteredToken) {
            jwtError.textContent = 'الرجاء إدخال رمز JWT.';
            return;
        }

        // محاولة تحليل الرمز وتحديث الواجهة
        const setupSuccess = setupUIBasedOnToken(enteredToken);

        if (setupSuccess) {
             // إذا نجح الإعداد، احفظ الرمز الجديد (إذا كان مختلفًا أو للمرة الأولى)
             localStorage.setItem('chat_jwt', enteredToken);
             // مسح حقل الإدخال بعد الاستخدام الناجح
             jwtInput.value = '';
             // امسح حالة الدردشة السابقة لأن المستخدم قد يكون تغير
             clearChatState();
        }
        // رسالة الخطأ سيتم عرضها بواسطة setupUIBasedOnToken في حالة الفشل
    });


    // معالج حدث تحميل المحادثة
    loadChatBtn.addEventListener('click', async () => {
        const otherId = parseInt(otherUserIdInput.value, 10);
        loadChatError.textContent = '';
        // لا تمسح الرسائل هنا للسماح بالتبديل السريع، fetchMessages سيفعل ذلك
        // chatMessagesDiv.innerHTML = '';
        currentChatInfo.textContent = '';
        stopPolling(); // أوقف التحديث القديم قبل بدء الجديد

        if (!otherId || isNaN(otherId)) {
            loadChatError.textContent = 'الرجاء إدخال معرف مستخدم صحيح.';
            return;
        }
         if (otherId === currentUserId) {
            loadChatError.textContent = 'لا يمكنك الدردشة مع نفسك.';
            return;
        }

        currentChatPartnerId = otherId;
        currentChatInfo.textContent = `المحادثة مع المستخدم ID: ${currentChatPartnerId}`;
        await fetchMessages();
         startPolling(); // بدء التحديث الدوري للمحادثة الجديدة
    });

    // دالة جلب الرسائل
    async function fetchMessages() {
        if (!currentChatPartnerId || !jwtToken) {
             // console.warn("لا يمكن جلب الرسائل: ID المستخدم الآخر أو Token غير موجود.");
             // لا تعرض خطأ هنا، قد يكون المستخدم لم يختر محادثة بعد
             return;
        }

        // لا تظهر التحميل إلا إذا كانت منطقة الرسائل فارغة تمامًا
        if (chatMessagesDiv.innerHTML.trim() === '') {
            showLoading(true);
        }
        loadChatError.textContent = '';

        try {
            const response = await fetch(`/api/messages/${currentChatPartnerId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                }
            });

            if (response.ok) {
                const messages = await response.json();
                 // قارن الرسائل الجديدة بالقديمة لمنع إعادة الرسم غير الضرورية (تحسين بسيط)
                // هذا يتطلب طريقة لمعرفة آخر رسالة معروضة، للتبسيط سنعيد الرسم الآن
                const firstLoad = chatMessagesDiv.innerHTML.trim() === '';
                chatMessagesDiv.innerHTML = ''; // مسح الرسائل قبل عرض الجديدة
                messages.forEach(displayMessage);
                // التمرير للأسفل فقط عند التحميل الأول أو عند إضافة رسالة جديدة (ليس في كل تحديث)
                // للتبسيط، سنمرر دائماً الآن
                scrollToBottom();
            } else if (response.status === 401) {
                 handleLogout("انتهت صلاحية الجلسة أو الرمز غير صالح. يرجى إدخال رمز صالح.");
            }
             else {
                const errorData = await response.json();
                loadChatError.textContent = `خطأ في جلب الرسائل: ${errorData.error || response.statusText}`;
                 stopPolling(); // أوقف التحديث إذا حدث خطأ دائم
            }
        } catch (error) {
            console.error('Fetch messages error:', error);
            loadChatError.textContent = 'حدث خطأ في الشبكة أو الخادم أثناء جلب الرسائل.';
            stopPolling(); // أوقف التحديث عند خطأ في الشبكة
        } finally {
             showLoading(false); // إخفاء التحميل دائمًا
        }
    }

    // معالج حدث إرسال الرسالة
    sendForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        sendError.textContent = '';
        const content = messageInput.value.trim();

        if (!content) {
            sendError.textContent = 'لا يمكن إرسال رسالة فارغة.';
            return;
        }
        if (!currentChatPartnerId) {
            sendError.textContent = 'الرجاء اختيار مستخدم للدردشة معه أولاً.';
            return;
        }
        if (!jwtToken || !currentUserId) {
             handleLogout('الرمز غير موجود أو غير صالح. يرجى إدخال رمز صالح.');
            return;
        }

        try {
            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({
                    receiver_id: currentChatPartnerId,
                    content: content
                })
            });

            const data = await response.json();

            if (response.status === 201) {
                messageInput.value = ''; // مسح حقل الإدخال
                const sentMessage = {
                    id: Date.now(), // ID مؤقت
                    content: content,
                    sender_id: currentUserId,
                    receiver_id: currentChatPartnerId,
                    created_at: new Date().toISOString() // وقت تقريبي
                };
                displayMessage(sentMessage);
                scrollToBottom();
                // لا حاجة لاستدعاء fetchMessages() هنا، التحديث الدوري سيجلبها
            } else if (response.status === 401) {
                 handleLogout("انتهت صلاحية الجلسة أو الرمز غير صالح. يرجى إدخال رمز صالح.");
            }
             else {
                sendError.textContent = `خطأ في الإرسال: ${data.error || data.message || 'حدث خطأ غير معروف'}`;
            }
        } catch (error) {
            console.error('Send message error:', error);
            sendError.textContent = 'حدث خطأ في الشبكة أو الخادم أثناء الإرسال.';
        }
    });

    // --- Polling ---
    function startPolling() {
        stopPolling();
        if (currentChatPartnerId && jwtToken) {
            console.log(`بدء التحديث الدوري كل 5 ثوانٍ للمحادثة مع ${currentChatPartnerId}`);
            // جلب فوري عند البدء ثم كل 5 ثواني
            fetchMessages();
            pollingInterval = setInterval(fetchMessages, 5000);
        }
    }

    function stopPolling() {
        if (pollingInterval) {
            console.log("إيقاف التحديث الدوري.");
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }

    // معالج حدث تسجيل الخروج
    logoutBtn.addEventListener('click', () => handleLogout());

    function handleLogout(logoutMessage = "تم تسجيل الخروج.") {
         stopPolling();
         jwtToken = null;
         currentUserId = null;
         localStorage.removeItem('chat_jwt');
         chatSection.style.display = 'none';
         jwtSection.style.display = 'block';
         jwtInput.value = ''; // مسح الحقل
         jwtError.textContent = logoutMessage; // عرض سبب الخروج إن وجد
         clearChatState(); // مسح كل بيانات الدردشة
         console.log("تم تسجيل الخروج.");
    }

    // إيقاف التحديث الدوري عند إغلاق الصفحة
     window.addEventListener('beforeunload', stopPolling);

</script>

</body>
</html>