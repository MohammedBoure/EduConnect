<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المنشورات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --text-color: #333;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
        }

        nav {
            background-color: var(--primary-color);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        nav ul {
            display: flex;
            justify-content: flex-start;
            list-style: none;
            padding: 0 1rem;
            margin: 0;
        }

        nav ul li a {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            padding: 1rem;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 1rem;
        }

        nav ul li a:hover {
            background-color: var(--secondary-color);
        }

        nav ul li a.active {
            background-color: var(--secondary-color);
        }

        nav ul li a i {
            margin-left: 0.5rem;
        }

        #logoutBtn {
            color: #ff6b6b;
        }

        #logoutBtn:hover {
            background-color: #ff6b6b;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header-section {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-section h1 {
            color: var(--primary-color);
            position: relative;
            padding-bottom: 0.5rem;
        }

        .header-section h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 50px;
            height: 3px;
            background-color: var(--secondary-color);
        }

        .tools .btn-primary {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .tools .btn-primary:hover {
            background-color: #2980b9;
        }

        .tools .btn-primary i {
            margin-left: 0.5rem;
        }

        .message {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .message i {
            margin-left: 0.5rem;
            font-size: 1.2rem;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .loading i {
            animation: spin 1s infinite linear;
            margin-left: 0.5rem;
            font-size: 1.5rem;
        }

        .table-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            border: 1px solid #eee;
            padding: 0.75rem;
            text-align: right;
        }

        thead th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .post-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }

        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-info {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #2980b9;
        }

        .btn-edit {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-edit:hover {
            background-color: #e67e22;
        }

        .btn-delete {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background-color: #c0392b;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: #777;
        }

        .no-data i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.3rem;
            margin-top: 1rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background-color: white;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .pagination button:hover:not([disabled]) {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination button.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            font-size: 0.9rem;
            margin: 0 0.5rem;
            color: #555;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .modal-header h2 i {
            margin-left: 0.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--text-color);
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .modal-body table {
            margin-bottom: 1rem;
        }

        .modal-body th,
        .modal-body td {
            font-size: 0.9rem;
        }

        .modal-body .author-img-sm {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        .modal-body .comment-content {
            max-width: 350px;
            white-space: normal;
            word-break: break-word;
        }

        .modal-body .no-data-modal {
            text-align: center;
            padding: 1.5rem;
            color: #777;
        }

        .modal-body .loading-modal {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            color: var(--secondary-color);
        }

        .modal-body .loading-modal i {
            animation: spin 1s infinite linear;
            margin-left: 0.5rem;
        }

        .modal-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .modal-pagination button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .modal-pagination span {
            font-size: 0.9rem;
            margin: 0 0.5rem;
        }

        /* Edit Comment Modal */
        #editCommentModal .modal-content {
            max-width: 500px;
            margin: 15% auto;
        }

        #editCommentModal label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--primary-color);
        }

        #editCommentModal textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            min-height: 100px;
        }

        #editCommentModal textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        #editCommentModal .modal-footer {
            padding-top: 1rem;
            border-top: 1px solid #eee;
            text-align: left;
        }

        #editCommentModal .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        #editCommentModal .btn-primary:hover {
            background-color: #2980b9;
        }

        #editCommentModal .btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
        }

        #editCommentModal .btn-secondary:hover {
            background-color: #dfe6e9;
        }

        /* Add Comment Section */
        .add-comment-section {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .add-comment-section h3 {
            margin: 0 0 0.75rem;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .add-comment-section h3 i {
            margin-left: 0.5rem;
        }

        .add-comment-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .add-comment-form label {
            font-weight: 500;
            color: var(--primary-color);
        }

        .add-comment-form input[type="text"],
        .add-comment-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .add-comment-form input[type="text"]:focus,
        .add-comment-form textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .add-comment-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .add-comment-form .btn-primary {
            align-self: flex-end;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        .form-error {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: none;
        }

        /* تنسيق خلية العنوان */
        td.post-title-cell {
            padding: 0.6rem;
            vertical-align: middle;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            position: relative;
            font-weight: 500;
            color: var(--text-color); /* #333 */
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        td.post-title-cell:hover {
            background-color: var(--light-color); /* #ecf0f1 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(-3px);
        }

        /* تلميح عند التمرير */
        td.post-title-cell:hover:after {
            content: 'عرض تفاصيل المنشور';
            position: absolute;
            top: -2.8rem;
            right: 50%;
            transform: translateX(50%);
            background-color: var(--primary-color); /* #2c3e50 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            animation: fadeInTooltip 0.3s ease forwards;
            animation-delay: 0.4s;
        }

        @keyframes fadeInTooltip {
            to {
                opacity: 1;
            }
        }

        /* تحسين التوافق مع الأجهزة الصغيرة */
        @media (max-width: 768px) {
            td.post-title-cell {
                font-size: 0.9rem;
                padding: 0.4rem;
            }
            td.post-title-cell:hover:after {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }

        @media (max-width: 576px) {
            td.post-title-cell {
                font-size: 0.85rem;
                padding: 0.3rem;
            }
            td.post-title-cell:hover:after {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
            }
            nav ul {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            nav ul li {
                flex: 0 0 auto;
            }

            .header-section {
                flex-direction: column;
                align-items: flex-start;
            }

            .tools {
                margin-top: 1rem;
            }

            th, td {
                font-size: 0.75rem;
                padding: 0.4rem;
            }

            .post-img {
                width: 40px;
                height: 40px;
            }

            .actions .btn-sm {
                padding: 0.15rem 0.4rem;
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li><a href="admin_users.html"><i class="fas fa-users"></i> إدارة المستخدمين</a></li>
            <li><a href="admin_posts.html" class="active"><i class="fas fa-file-alt"></i> إدارة المنشورات</a></li>
            <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header-section">
            <h1>إدارة المنشورات</h1>
            <div class="tools">
                <a href="admin_post_create.html" class="btn btn-primary">
                    <i class="fas fa-plus"></i> إنشاء منشور جديد
                </a>
            </div>
        </div>

        <div id="message" class="message" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">
            <i class="fas fa-spinner"></i> جاري تحميل المنشورات...
        </div>

        <div class="table-container" id="tableContainer" style="display: none;">
            <table id="postsTable">
                <thead>
                    <tr>
                        <th width="80">المعرف</th>
                        <th>العنوان</th>
                        <th width="100">الصورة</th>
                        <th>المؤلف</th>
                        <th>تاريخ الإنشاء</th>
                        <th width="150">إجراءات</th>
                    </tr>
                </thead>
                <tbody id="postsTbody"></tbody>
            </table>
        </div>

        <div id="noPosts" class="no-data" style="display: none;">
            <i class="fas fa-file-alt"></i>
            <p>لا توجد منشورات لعرضها حاليًا.</p>
        </div>

        <div id="pagination" class="pagination"></div>
    </div>

    <div id="viewCommentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewCommentsModalTitle"><i class="fas fa-comments"></i> تعليقات المنشور</h2>
                <button type="button" class="close-btn" data-modal-id="viewCommentsModal">×</button>
            </div>
            <div class="modal-body" id="viewCommentsModalBody">
                <div class="add-comment-section">
                    <h3><i class="fas fa-comment-medical"></i> إضافة تعليق جديد</h3>
                    <form id="addCommentForm" class="add-comment-form">
                        <input type="hidden" id="addCommentPostId" value="">
                        <div>
                            <label for="addCommentUserId">معرف المستخدم <span style="color: red">*</span></label>
                            <input type="text" id="addCommentUserId" placeholder="أدخل معرف المستخدم" required>
                        </div>
                        <div>
                            <label for="addCommentContent">التعليق <span style="color: red">*</span></label>
                            <textarea id="addCommentContent" placeholder="اكتب تعليقك هنا..." required></textarea>
                        </div>
                        <p id="addCommentError" class="form-error"></p>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> إرسال التعليق</button>
                    </form>
                </div>
                <div id="modalLoading" class="loading-modal" style="display: none;">
                    <i class="fas fa-spinner"></i> جاري تحميل التعليقات...
                </div>
                <div id="modalNoComments" class="no-data-modal" style="display: none;">
                    <p>لا توجد تعليقات لهذا المنشور.</p>
                </div>
                <table id="modalCommentsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="150">المؤلف</th>
                            <th>التعليق</th>
                            <th>تاريخ الإنشاء</th>
                            <th width="100">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="modalCommentsTbody"></tbody>
                </table>
                <div id="modalPagination" class="modal-pagination"></div>
            </div>
        </div>
    </div>

    <div id="editCommentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> تعديل التعليق</h2>
                <button type="button" class="close-btn" data-modal-id="editCommentModal">×</button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <input type="hidden" id="editCommentId">
                    <input type="hidden" id="editCommentPostId">
                    <div>
                        <label for="editContent">محتوى التعليق <span style="color: red">*</span></label>
                        <textarea id="editContent" rows="5" required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التعديلات</button>
                        <button type="button" class="btn btn-secondary close-btn" data-modal-id="editCommentModal"><i class="fas fa-times"></i> إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Ensure user is authenticated for admin actions
        redirectToLoginIfNotAuthenticated();

        // Main Interface Elements
        const postsTbody = document.getElementById('postsTbody');
        const tableContainer = document.getElementById('tableContainer');
        const loadingDiv = document.getElementById('loading');
        const noPostsP = document.getElementById('noPosts');
        const paginationDiv = document.getElementById('pagination');
        const messageDiv = document.getElementById('message');
        const logoutBtn = document.getElementById('logoutBtn');

        // View Comments Modal Elements
        const viewCommentsModal = document.getElementById('viewCommentsModal');
        const viewCommentsModalTitle = document.getElementById('viewCommentsModalTitle');
        const modalLoading = document.getElementById('modalLoading');
        const modalNoComments = document.getElementById('modalNoComments');
        const modalCommentsTable = document.getElementById('modalCommentsTable');
        const modalCommentsTbody = document.getElementById('modalCommentsTbody');
        const modalPaginationDiv = document.getElementById('modalPagination');

        // Add Comment Form Elements
        const addCommentForm = document.getElementById('addCommentForm');
        const addCommentPostIdInput = document.getElementById('addCommentPostId');
        const addCommentUserIdInput = document.getElementById('addCommentUserId');
        const addCommentContentInput = document.getElementById('addCommentContent');
        const addCommentError = document.getElementById('addCommentError');

        // Edit Comment Modal Elements
        const editCommentModal = document.getElementById('editCommentModal');
        const editCommentForm = document.getElementById('editCommentForm');
        const editCommentIdInput = document.getElementById('editCommentId');
        const editCommentPostIdInput = document.getElementById('editCommentPostId');
        const editContentInput = document.getElementById('editContent');

        // State Variables
        let currentPage = 1;
        const perPage = 10;
        const modalCommentsPerPage = 5;
        let currentViewingPostId = null;
        let currentModalCommentsPage = 1;

        // Helper Functions
        function showLoading(show) {
            loadingDiv.style.display = show ? 'flex' : 'none';
            if (show) {
                tableContainer.style.display = 'none';
                noPostsP.style.display = 'none';
                messageDiv.style.display = 'none';
                paginationDiv.style.display = 'none';
            }
        }

        function showMessage(text, type = 'success') {
            messageDiv.className = `message ${type}`;
            const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
            messageDiv.innerHTML = `${icon} ${text}`;
            messageDiv.style.display = 'flex';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Load and Render Posts
        async function loadPosts(page = 1) {
            showLoading(true);
            currentPage = page;

            const result = await apiGetPosts(page, perPage);
            showLoading(false);

            if (result.ok && result.data.posts) {
                renderPosts(result.data.posts);
                renderPagination(result.data.page, result.data.pages);
            } else {
                showMessage(`فشل تحميل المنشورات: ${result.error || 'خطأ غير معروف'}`, 'error');
                tableContainer.style.display = 'none';
                noPostsP.style.display = 'block';
            }
        }

        function renderPosts(posts) {
            postsTbody.innerHTML = '';

            if (posts.length > 0) {
                tableContainer.style.display = 'block';
                noPostsP.style.display = 'none';

                posts.forEach(post => {
                    const row = postsTbody.insertRow();
                    const authorName = post.author ? `${post.author.first_name || ''} ${post.author.last_name || ''}` : 'غير معروف';
                    const creationDate = post.created_at ? formatDate(post.created_at) : '-';
                    const imageSrc = post.image ? escapeHtml(post.image) : 'https://via.placeholder.com/60x60'; // صورة افتراضية

                    row.innerHTML = `
                        <td>${post.id}</td>
                        <td class="post-title-cell" onclick="openPostView(${post.id})" title="عرض تفاصيل المنشور">
                            ${escapeHtml(post.title) || 'بدون عنوان'}
                        </td>
                        <td><img src="${imageSrc}" alt="صورة المنشور" class="post-img" onerror="this.src='https://via.placeholder.com/60x60'"></td>
                        <td>${escapeHtml(authorName)}</td>
                        <td>${creationDate}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-info view-comments-btn" data-post-id="${post.id}" title="عرض التعليقات">
                                <i class="fas fa-comments"></i>
                            </button>
                            <button class="btn btn-sm btn-edit" onclick="editPost(${post.id})" title="تعديل المنشور">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deletePost(${post.id}, '${escapeHtml(post.title)}')" title="حذف المنشور">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-primary btn-open" onclick="openPostView(${post.id})" title="فتح واجهة">
                                <i class="fas fa-window-restore"></i>
                            </button>
                        </td>
                    `;
                    row.querySelector('.view-comments-btn').addEventListener('click', (e) => {
                        const postId = e.currentTarget.dataset.postId;
                        openViewCommentsModal(postId);
                    });
                });
            } else {
                tableContainer.style.display = 'none';
                noPostsP.style.display = 'block';
                paginationDiv.style.display = 'none';
            }
        }

        function renderPagination(currentPage, totalPages) {
            paginationDiv.innerHTML = '';

            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }

            paginationDiv.style.display = 'flex';

            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.title = 'الصفحة السابقة';
            prevButton.onclick = () => loadPosts(currentPage - 1);
            paginationDiv.appendChild(prevButton);

            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            if (startPage > 1) {
                const firstPageButton = document.createElement('button');
                firstPageButton.textContent = '1';
                firstPageButton.onclick = () => loadPosts(1);
                paginationDiv.appendChild(firstPageButton);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    paginationDiv.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPage);
                pageButton.onclick = () => loadPosts(i);
                paginationDiv.appendChild(pageButton);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    paginationDiv.appendChild(dots);
                }
                const lastPageButton = document.createElement('button');
                lastPageButton.textContent = totalPages;
                lastPageButton.onclick = () => loadPosts(totalPages);
                paginationDiv.appendChild(lastPageButton);
            }

            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            nextButton.disabled = currentPage >= totalPages;
            nextButton.title = 'الصفحة التالية';
            nextButton.onclick = () => loadPosts(currentPage + 1);
            paginationDiv.appendChild(nextButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `${currentPage} من ${totalPages}`;
            paginationDiv.appendChild(pageInfo);
        }

        // Comments Modal Functions
        function openViewCommentsModal(postId) {
            currentViewingPostId = postId;
            currentModalCommentsPage = 1;
            viewCommentsModalTitle.innerHTML = `<i class="fas fa-comments"></i> تعليقات المنشور #${postId}`;
            addCommentPostIdInput.value = postId;
            addCommentUserIdInput.value = '';
            addCommentContentInput.value = '';
            addCommentError.style.display = 'none';
            modalLoading.style.display = 'flex';
            modalCommentsTable.style.display = 'none';
            modalNoComments.style.display = 'none';
            modalCommentsTbody.innerHTML = '';
            modalPaginationDiv.innerHTML = '';
            viewCommentsModal.style.display = 'block';
            loadPostCommentsForModal(postId, 1);
        }

        async function loadPostCommentsForModal(postId, page) {
            modalLoading.style.display = 'flex';
            modalCommentsTable.style.display = 'none';
            modalNoComments.style.display = 'none';
            currentModalCommentsPage = page;

            const result = await apiAdminGetPostComments(postId, page, modalCommentsPerPage);

            modalLoading.style.display = 'none';

            if (result.ok && result.data.comments) {
                renderPostCommentsInModal(result.data.comments);
                const totalPages = result.data.pages || Math.ceil(result.data.total / modalCommentsPerPage);
                renderModalPagination(postId, result.data.page, totalPages);
            } else {
                modalCommentsTbody.innerHTML = '';
                modalNoComments.innerHTML = `<p class="text-danger">فشل تحميل التعليقات: ${result.error || 'خطأ غير معروف'}</p>`;
                modalNoComments.style.display = 'block';
                modalPaginationDiv.innerHTML = '';
            }
        }

        function renderPostCommentsInModal(comments) {
            modalCommentsTbody.innerHTML = '';

            if (comments.length > 0) {
                modalCommentsTable.style.display = 'table';
                modalNoComments.style.display = 'none';

                comments.forEach(comment => {
                    const row = modalCommentsTbody.insertRow();
                    const author = comment.author || {};
                    const photoHtml = author.photo
                        ? `<img src="${escapeHtml(author.photo)}" alt="صورة المؤلف" class="author-img-sm">`
                        : `<span style="display:inline-block;width:30px;height:30px;line-height:30px;text-align:center;background:#eee;border-radius:50%;font-size:14px;vertical-align:middle;margin-left:5px;"><i class="fas fa-user"></i></span>`;

                    row.innerHTML = `
                        <td>
                            ${photoHtml}
                            <span>${escapeHtml(author.first_name || '')} ${escapeHtml(author.last_name || '(غير معروف)')}</span>
                        </td>
                        <td class="comment-content">${escapeHtml(comment.content) || ''}</td>
                        <td>${formatDate(comment.created_at)}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-edit modal-edit-comment-btn" data-comment-id="${comment.id}" data-comment-content="${escapeHtml(comment.content)}" title="تعديل التعليق">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete modal-delete-comment-btn" data-comment-id="${comment.id}" title="حذف التعليق">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    row.querySelector('.modal-edit-comment-btn').addEventListener('click', handleModalEditClick);
                    row.querySelector('.modal-delete-comment-btn').addEventListener('click', handleModalDeleteClick);
                });
            } else {
                modalCommentsTable.style.display = 'none';
                modalNoComments.innerHTML = '<p>لا توجد تعليقات لهذا المنشور.</p>';
                modalNoComments.style.display = 'block';
            }
        }

        function renderModalPagination(postId, currentPage, totalPages) {
            modalPaginationDiv.innerHTML = '';

            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.title = 'الصفحة السابقة';
            prevButton.onclick = () => loadPostCommentsForModal(postId, currentPage - 1);
            modalPaginationDiv.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `صفحة ${currentPage} من ${totalPages}`;
            modalPaginationDiv.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            nextButton.disabled = currentPage >= totalPages;
            nextButton.title = 'الصفحة التالية';
            nextButton.onclick = () => loadPostCommentsForModal(postId, currentPage + 1);
            modalPaginationDiv.appendChild(nextButton);
        }

        // Handle Add Comment Form Submission
        addCommentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = addCommentPostIdInput.value;
            const userId = addCommentUserIdInput.value.trim();
            const content = addCommentContentInput.value.trim();

            if (!userId) {
                addCommentError.textContent = 'معرف المستخدم لا يمكن أن يكون فارغًا.';
                addCommentError.style.display = 'block';
                return;
            }

            if (!content) {
                addCommentError.textContent = 'محتوى التعليق لا يمكن أن يكون فارغًا.';
                addCommentError.style.display = 'block';
                return;
            }

            addCommentError.style.display = 'none';

            const submitButton = addCommentForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner"></i> جاري الإرسال...';

            const commentData = {
                content: content,
                user_id: userId
            };

            const result = await apiAdminCreateComment(postId, commentData);

            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;

            if (result.ok) {
                showMessage('تم إضافة التعليق بنجاح.', 'success');
                addCommentUserIdInput.value = '';
                addCommentContentInput.value = '';
                loadPostCommentsForModal(postId, 1);
            } else {
                addCommentError.textContent = `فشل إضافة التعليق: ${result.error || 'خطأ غير معروف'}`;
                addCommentError.style.display = 'block';
            }
        });

        // Handle Edit Comment Button Click
        function handleModalEditClick(event) {
            const button = event.currentTarget;
            const commentId = button.dataset.commentId;
            const content = button.dataset.commentContent;

            editCommentIdInput.value = commentId;
            editContentInput.value = content;
            editCommentPostIdInput.value = currentViewingPostId;
            editCommentModal.style.display = 'block';
        }

        // Handle Edit Comment Form Submission
        editCommentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentId = editCommentIdInput.value;
            const postId = editCommentPostIdInput.value;
            const content = editContentInput.value.trim();

            if (!content) {
                addCommentError.textContent = 'محتوى التعليق لا يمكن أن يكون فارغًا.';
                addCommentError.style.display = 'block';
                return;
            }

            const commentData = { content: content };
            const submitButton = editCommentForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner"></i> جاري الحفظ...';

            const result = await apiAdminUpdateComment(commentId, commentData);

            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;

            if (result.ok) {
                closeModal('editCommentModal');
                showMessage('تم تحديث التعليق بنجاح.', 'success');
                if (postId) {
                    loadPostCommentsForModal(postId, currentModalCommentsPage);
                }
            } else {
                addCommentError.textContent = `فشل تحديث التعليق: ${result.error || 'خطأ غير معروف'}`;
                addCommentError.style.display = 'block';
            }
        });

        // Handle Delete Comment Button Click
        async function handleModalDeleteClick(event) {
            const button = event.currentTarget;
            const commentId = button.dataset.commentId;

            if (confirm(`هل أنت متأكد من حذف التعليق رقم ${commentId}؟`)) {
                const result = await apiAdminDeleteComment(commentId);

                if (result.ok) {
                    showMessage(`تم حذف التعليق ${commentId} بنجاح.`, 'success');
                    if (currentViewingPostId) {
                        const currentCommentRows = modalCommentsTbody.rows.length - 1;
                        if (currentCommentRows === 0 && currentModalCommentsPage > 1) {
                            loadPostCommentsForModal(currentViewingPostId, currentModalCommentsPage - 1);
                        } else {
                            loadPostCommentsForModal(currentViewingPostId, currentModalCommentsPage);
                        }
                    }
                } else {
                    showMessage(`فشل حذف التعليق: ${result.error || 'خطأ غير معروف'}`, 'error');
                }
            }
        }

        // Close Modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
            if (modalId === 'viewCommentsModal') {
                currentViewingPostId = null;
            }
        }

        // Add Event Listeners for Close Buttons
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modalId = e.currentTarget.dataset.modalId;
                if (modalId) {
                    closeModal(modalId);
                }
            });
        });

        // Close Modal on Outside Click
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        });

        // Post Management Functions
        function editPost(postId) {
            window.location.href = `admin_post_edit.html?id=${postId}`;
        }

        async function deletePost(postId, postTitle) {
            if (confirm(`هل أنت متأكد من حذف المنشور "${postTitle}"؟`)) {
                showLoading(true);
                const result = await apiDeletePost(postId);
                showLoading(false);
                if (result.ok) {
                    showMessage(`تم حذف المنشور "${postTitle}" بنجاح`, 'success');
                    const remainingRows = postsTbody.rows.length - 1;
                    if (remainingRows === 0 && currentPage > 1) {
                        loadPosts(currentPage - 1);
                    } else {
                        loadPosts(currentPage);
                    }
                } else {
                    showMessage(`فشل حذف المنشور: ${result.error || 'خطأ غير معروف'}`, 'error');
                }
            }
        }

        function openPostView(postId) {
            window.location.href = `admin_post_view.html?id=${postId}`;
        }

        // Click Effect for Post Title Cell
        document.addEventListener('click', (e) => {
            const cell = e.target.closest('.post-title-cell');
            if (cell) {
                cell.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
                setTimeout(() => {
                    cell.style.backgroundColor = '';
                }, 300);
            }
        });

        // Logout and Initial Load
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                logout();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadPosts(1);
        });
    </script>
</body>
</html>